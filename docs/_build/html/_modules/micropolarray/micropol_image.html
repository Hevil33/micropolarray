<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>micropolarray.micropol_image &mdash; micropolarray  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            micropolarray
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../micropolarray.html">micropolarray package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">micropolarray</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">micropolarray.micropol_image</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for micropolarray.micropol_image</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">debug</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">warning</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">PILImage</span>

<span class="kn">from</span> <span class="nn">micropolarray.cameras</span> <span class="kn">import</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">PolarCam</span>
<span class="kn">from</span> <span class="nn">micropolarray.image</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">micropolarray.polarization_functions</span> <span class="kn">import</span> <span class="n">AoLP</span><span class="p">,</span> <span class="n">DoLP</span><span class="p">,</span> <span class="n">pB</span>
<span class="kn">from</span> <span class="nn">micropolarray.processing.chen_wan_liang_calibration</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_ifov_jitcorrect</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">micropolarray.processing.congrid</span> <span class="kn">import</span> <span class="n">congrid</span>
<span class="kn">from</span> <span class="nn">micropolarray.processing.demodulation</span> <span class="kn">import</span> <span class="n">Demodulator</span>
<span class="kn">from</span> <span class="nn">micropolarray.processing.demosaic</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">demosaic</span><span class="p">,</span>
    <span class="n">merge_polarizations</span><span class="p">,</span>
    <span class="n">split_polarizations</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">micropolarray.processing.nrgf</span> <span class="kn">import</span> <span class="n">roi_from_polar</span>
<span class="kn">from</span> <span class="nn">micropolarray.processing.rebin</span> <span class="kn">import</span> <span class="n">micropolarray_rebin</span>
<span class="kn">from</span> <span class="nn">micropolarray.processing.shift</span> <span class="kn">import</span> <span class="n">shift_micropol</span>
<span class="kn">from</span> <span class="nn">micropolarray.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_make_abs_and_create_dir</span><span class="p">,</span>
    <span class="n">fix_data</span><span class="p">,</span>
    <span class="n">mean_minus_std</span><span class="p">,</span>
    <span class="n">mean_plus_std</span><span class="p">,</span>
    <span class="n">timer</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="PolParam"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.PolParam">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PolParam</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Auxiliary class for polarization parameters.</span>

<span class="sd">    Members:</span>
<span class="sd">        ID (str): parameter identifier</span>
<span class="sd">        data (np.array): parameter image as numpy 2D array</span>
<span class="sd">        title (str): brief title of the parameter, useful for plotting</span>
<span class="sd">        measure_unit (str): initial measure units of the parameter</span>
<span class="sd">        fix_data (bool): controls whether data has to be constrained to [0, 4096] interval (not implemented yet)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ID</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">measure_unit</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">fix_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<span class="n">DEFAULT_ANGLES_DIC</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># sets the micropolarizer orientations with a dictionary {angle : position in superpix 1-&gt;3}</span>


<div class="viewcode-block" id="set_default_angles"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.set_default_angles">[docs]</a><span class="k">def</span> <span class="nf">set_default_angles</span><span class="p">(</span><span class="n">angles_dic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets the default micropolarizer orientations for images.</span>

<span class="sd">    Args:</span>
<span class="sd">        angles_dic (dict): dictionary {value : pos} where value is the angle in degrees from -90 to 90 and pos is the pixel position in superpixel, from 0 to 3 (position [y, x], fast index x)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DEFAULT_ANGLES_DIC</span>
    <span class="n">DEFAULT_ANGLES_DIC</span> <span class="o">=</span> <span class="n">angles_dic</span></div>


<div class="viewcode-block" id="MicropolImage"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage">[docs]</a><span class="k">class</span> <span class="nc">MicropolImage</span><span class="p">(</span><span class="n">Image</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Micro-polarizer array image class. Can be initialized from a 2d array, a list of 1 or more file names (use the boolean keyword averageimages to select if sum or average is taken) or another MicropolImage. Dark and flat micropolarray images can also be provided to automatically correct the result.&quot;&quot;&quot;</span>

    <span class="n">first_call</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Avoid repeating messages</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">initializer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">MicropolImage</span><span class="p">,</span>
        <span class="n">angle_dic</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dark</span><span class="p">:</span> <span class="n">MicropolImage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flat</span><span class="p">:</span> <span class="n">MicropolImage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">averageimages</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_internal_variables</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">angle_dic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">DEFAULT_ANGLES_DIC</span>
            <span class="k">if</span> <span class="n">DEFAULT_ANGLES_DIC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MicropolImage</span><span class="o">.</span><span class="n">first_call</span><span class="p">:</span>
                    <span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Micropolarizer orientation dictionary defaults to </span><span class="si">{</span><span class="n">PolarCam</span><span class="p">()</span><span class="o">.</span><span class="n">angle_dic</span><span class="si">}</span><span class="s2">, set it via set_default_angles(camera)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">MicropolImage</span><span class="o">.</span><span class="n">first_call</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">DEFAULT_ANGLES_DIC</span> <span class="o">=</span> <span class="n">PolarCam</span><span class="p">()</span><span class="o">.</span><span class="n">angle_dic</span>
            <span class="n">angle_dic</span> <span class="o">=</span> <span class="n">DEFAULT_ANGLES_DIC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span> <span class="o">=</span> <span class="n">angle_dic</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">initializer</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">initializer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_of_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">initializer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_of_images</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">initializer</span><span class="p">,</span> <span class="n">averageimages</span><span class="o">=</span><span class="n">averageimages</span>
        <span class="p">)</span>  <span class="c1"># Call generic Image() constructor</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">initializer</span><span class="p">)</span> <span class="ow">is</span> <span class="n">MicropolImage</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_import_image_parameters</span><span class="p">(</span><span class="n">initializer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_theo_Stokes_vec_components</span><span class="p">()</span>

        <span class="c1"># Apply corrections if needed</span>
        <span class="k">if</span> <span class="n">dark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtract_dark</span><span class="p">(</span><span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correct_flat</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="n">flat</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">MicropolImage</span><span class="o">.</span><span class="n">first_call</span><span class="p">:</span>
            <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Remember to set dark&quot;</span><span class="p">)</span>
            <span class="n">MicropolImage</span><span class="o">.</span><span class="n">first_call</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_initialize_internal_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_demodulated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_demosaiced</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binning</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flat_subtracted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dark_subtracted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_import_image_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">MicropolImage</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">angle_dic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">Stokes_vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_demodulated</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">_is_demodulated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_demosaiced</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">_is_demosaiced</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binning</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">_binning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dark_subtracted</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">_dark_subtracted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flat_subtracted</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">_flat_subtracted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">demosaiced_images</span>

    <span class="c1"># ----------------------------------------------------------------</span>
    <span class="c1"># -------------------- POLARIZATION PROPERTIES -------------------</span>
    <span class="c1"># ----------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Stokes I&quot;</span><span class="p">,</span> <span class="s2">&quot;DN&quot;</span><span class="p">,</span> <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Q</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Stokes Q&quot;</span><span class="p">,</span> <span class="s2">&quot;DN&quot;</span><span class="p">,</span> <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">U</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;Stokes U&quot;</span><span class="p">,</span> <span class="s2">&quot;DN&quot;</span><span class="p">,</span> <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pB</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;pB&quot;</span><span class="p">,</span>
            <span class="n">pB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span><span class="p">),</span>
            <span class="s2">&quot;Polarized brightness&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DN&quot;</span><span class="p">,</span>
            <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">AoLP</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;AoLP&quot;</span><span class="p">,</span>
            <span class="n">AoLP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span><span class="p">),</span>
            <span class="s2">&quot;Angle of Linear Polarization&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rad&quot;</span><span class="p">,</span>
            <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">DoLP</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;DoLP&quot;</span><span class="p">,</span>
            <span class="n">DoLP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span><span class="p">),</span>
            <span class="s2">&quot;Degree of Linear Polarization&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">polparam_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AoLP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DoLP</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">single_pol_subimages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">split_polarizations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_pol_subimages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="s2">&quot;0 deg orientation pixels&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DN&quot;</span><span class="p">,</span>
            <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol45</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;45&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_pol_subimages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">[</span><span class="mi">45</span><span class="p">]],</span>
            <span class="s2">&quot;45 deg orientation pixels&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DN&quot;</span><span class="p">,</span>
            <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol_45</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;-45&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_pol_subimages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">[</span><span class="o">-</span><span class="mi">45</span><span class="p">]],</span>
            <span class="s2">&quot;-45 deg orientation pixels&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DN&quot;</span><span class="p">,</span>
            <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pol90</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolParam</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PolParam</span><span class="p">(</span>
            <span class="s2">&quot;90&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_pol_subimages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">[</span><span class="mi">90</span><span class="p">]],</span>
            <span class="s2">&quot;90 deg orientation pixels&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DN&quot;</span><span class="p">,</span>
            <span class="n">fix_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ----------------------------------------------------------------</span>
    <span class="c1"># ---------------------- STOKES COMPONENTS -----------------------</span>
    <span class="c1"># ----------------------------------update_dim------------------------------</span>

    <span class="k">def</span> <span class="nf">_update_data_and_Stokes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newdata</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">newdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">newdata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_theo_Stokes_vec_components</span><span class="p">()</span>

<div class="viewcode-block" id="MicropolImage.demodulate"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.demodulate">[docs]</a>    <span class="k">def</span> <span class="nf">demodulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">demodulator</span><span class="p">:</span> <span class="n">Demodulator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a MicropolImage with polarization parameters calculated from the demodulation tensor provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            demodulator (Demodulator): Demodulator object containing the demodulation tensor components (see processing.new_demodulation)</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: raised if image and demodulator do not have the same dimension, for example in case of different binning</span>

<span class="sd">        Returns:</span>
<span class="sd">            MicropolImage: copy of the input imagreturn e with I, Q, U, pB, DoLP, AoLP calculated from the demodulation tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span>
            <span class="n">demodulator</span><span class="o">.</span><span class="n">mij</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">demodulator</span><span class="o">.</span><span class="n">mij</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">demodulator</span><span class="o">.</span><span class="n">mij</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">demodulator</span><span class="o">.</span><span class="n">mij</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Image and demodulator do not have the same dimensions, check binning.&quot;</span>
            <span class="p">)</span>
        <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Demodulating...&quot;</span><span class="p">)</span>
        <span class="n">demodulated_image</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">demodulated_image</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">demodulated_image</span><span class="o">.</span><span class="n">_get_Stokes_from_demodulator</span><span class="p">(</span><span class="n">demodulator</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">demodulated_image</span><span class="o">.</span><span class="n">_is_demodulated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Image correctly demodulated&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">demodulated_image</span></div>

    <span class="k">def</span> <span class="nf">_get_theo_Stokes_vec_components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes stokes vector components from four polarized images at four angles, angle_dic describes the coupling between</span>
<span class="sd">        poled_images_array[i] &lt;--&gt; angle_dic[i]</span>
<span class="sd">        Return:</span>
<span class="sd">            stokes vector, shape=(3, poled_images.shape[1], poled_images.shape[0])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_demosaiced</span><span class="p">:</span>
            <span class="n">subimages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subimages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_pol_subimages</span>
        <span class="n">I</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">subimages</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">subimages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">subimages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">[</span><span class="mi">90</span><span class="p">]]</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">subimages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">[</span><span class="mi">45</span><span class="p">]]</span> <span class="o">-</span> <span class="n">subimages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">[</span><span class="o">-</span><span class="mi">45</span><span class="p">]]</span>

        <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">I</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">S</span>

    <span class="k">def</span> <span class="nf">_get_Stokes_from_demodulator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">demodulator</span><span class="p">:</span> <span class="n">Demodulator</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes stokes vector components from four polarized images at four angles, angle_dic describes the coupling between</span>
<span class="sd">        poled_images_array[i] &lt;--&gt; angle_dic[i]. Assumes:</span>

<span class="sd">        I = M_00 * I_1 + M_01 * I_2 + M_02 * I_3 + M_03 * I_4</span>
<span class="sd">        Q = M_10 * I_1 + M_11 * I_2 + M_12 * I_3 + M_13 * I_4</span>
<span class="sd">        U = M_20 * I_1 + M_21 * I_2 + M_22 * I_3 + M_23 * I_4</span>

<span class="sd">        Return:</span>
<span class="sd">            stokes vector, shape=(3, poled_images.shape[1], poled_images.shape[0])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Corrected with demodulation matrices, S.shape = (4, n, m)</span>
        <span class="n">num_of_malus_parameters</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 3 multiplication params</span>
        <span class="n">pixels_in_superpix</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">mij</span> <span class="o">=</span> <span class="n">demodulator</span><span class="o">.</span><span class="n">mij</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">demosaic</span><span class="p">()</span>
        <span class="n">demosaiced_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span>

        <span class="c1"># IMG = np.array(</span>
        <span class="c1">#    [</span>
        <span class="c1">#        demosaiced_images[self.angle_dic[0]],</span>
        <span class="c1">#        demosaiced_images[self.angle_dic[45]],</span>
        <span class="c1">#        demosaiced_images[self.angle_dic[-45]],</span>
        <span class="c1">#        demosaiced_images[self.angle_dic[90]],</span>
        <span class="c1">#    ],</span>
        <span class="c1">#    dtype=float,</span>
        <span class="c1"># )  # Liberatore article/thesis</span>

        <span class="n">IMG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">demo_image</span> <span class="k">for</span> <span class="n">demo_image</span> <span class="ow">in</span> <span class="n">demosaiced_images</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IMG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">mij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IMG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;demodulation matrix and demosaiced images have different shape </span><span class="si">{</span><span class="n">mij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">IMG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Check that binning is correct.&quot;</span>
            <span class="p">)</span>  <span class="c1"># sanity check</span>

        <span class="n">T_ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                <span class="n">num_of_malus_parameters</span><span class="p">,</span>
                <span class="n">pixels_in_superpix</span><span class="p">,</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_malus_parameters</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pixels_in_superpix</span><span class="p">):</span>
                <span class="n">temp_tij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                    <span class="n">demodulator</span><span class="o">.</span><span class="n">mij</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">IMG</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="p">)</span>  <span class="c1"># Matrix product</span>
                <span class="n">T_ij</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp_tij</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_ij</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">I</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">S</span>

<div class="viewcode-block" id="MicropolImage.subtract_dark"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.subtract_dark">[docs]</a>    <span class="k">def</span> <span class="nf">subtract_dark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dark</span><span class="p">:</span> <span class="n">MicropolImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Correctly subtracts the input dark image from the image</span>

<span class="sd">        Args:</span>
<span class="sd">            dark (MicropolImage): dark to subtract</span>

<span class="sd">        Returns:</span>
<span class="sd">            MicropolImage: copy of input image with dark subtracted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">dark</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fix data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_theo_Stokes_vec_components</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dark_subtracted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MicropolImage.correct_flat"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.correct_flat">[docs]</a>    <span class="k">def</span> <span class="nf">correct_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat</span><span class="p">:</span> <span class="n">MicropolImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalizes the flat and uses it to correStokes_vecct the image.</span>

<span class="sd">        Args:</span>
<span class="sd">            flat (MicropolImage): flat image, does not need to be normalized.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MicropolImage: copy of input image corrected by flat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">normalized_flat</span> <span class="o">=</span> <span class="n">flat</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flat</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">normalized_flat</span><span class="p">,</span>
            <span class="n">where</span><span class="o">=</span><span class="n">normalized_flat</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># self.data = np.where(self.data &gt;= 0, self.data, 0)</span>
        <span class="c1"># self.data = np.where(self.data &lt; 4096, self.data, 4096)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_theo_Stokes_vec_components</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flat_subtracted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MicropolImage.correct_ifov"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.correct_ifov">[docs]</a>    <span class="k">def</span> <span class="nf">correct_ifov</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Corrects differences in single pixels fields of view inside each superpixel</span>

<span class="sd">        Returns:</span>
<span class="sd">            MicropolImage: image with data corrected for field of view differences</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">corrected_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">corrected_data</span> <span class="o">=</span> <span class="n">_ifov_jitcorrect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_data_and_Stokes</span><span class="p">(</span><span class="n">corrected_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># ----------------------------------------------------------------</span>
    <span class="c1"># ------------------------------ SHOW ----------------------------</span>
    <span class="c1"># ----------------------------------------------------------------</span>

<div class="viewcode-block" id="MicropolImage.show_with_pol_params"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.show_with_pol_params">[docs]</a>    <span class="k">def</span> <span class="nf">show_with_pol_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a fig for each set of image parameters. User must call</span>
<span class="sd">        plt.show after this is called.</span>
<span class="sd">        Returned parameters:</span>
<span class="sd">        - Original image</span>
<span class="sd">        - Stokes vector I, Q, U</span>
<span class="sd">        - Angle, degree of linear polarizaimagetion Polarized brightness</span>


<span class="sd">        Args:</span>
<span class="sd">            cmap (str, optional): colormap string. Defaults to &quot;Greys_r&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: a (figure, axis) couple same as matplotlib.pyplot.subplots for the image data and another for the six polarization parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">image_fig</span><span class="p">,</span> <span class="n">imageax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mappable</span> <span class="o">=</span> <span class="n">imageax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">avg</span> <span class="o">-</span> <span class="n">stdev</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">avg</span> <span class="o">+</span> <span class="n">stdev</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">imageax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Image data (avrg </span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s2">3.2f</span><span class="si">}</span><span class="s2">+-</span><span class="si">{</span><span class="n">stdev</span><span class="si">:</span><span class="s2">3.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">imageax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [px]&quot;</span><span class="p">)</span>
        <span class="n">imageax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [px]&quot;</span><span class="p">)</span>
        <span class="n">image_fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
            <span class="n">mappable</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">imageax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;[DN]&quot;</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="n">data_ratio</span> <span class="o">*</span> <span class="mf">0.05</span>
        <span class="p">)</span>
        <span class="n">stokes_fig</span><span class="p">,</span> <span class="n">stokesax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">stokesax</span> <span class="o">=</span> <span class="n">stokesax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polparam_list</span><span class="p">,</span> <span class="n">stokesax</span><span class="p">):</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">mappable_stokes</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">parameter</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">avg</span> <span class="o">-</span> <span class="n">stdev</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">avg</span> <span class="o">+</span> <span class="n">stdev</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                <span class="n">parameter</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; (avrg </span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s2">3.2f</span><span class="si">}</span><span class="s2">+-</span><span class="si">{</span><span class="n">stdev</span><span class="si">:</span><span class="s2">3.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [px]&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [px]&quot;</span><span class="p">)</span>
            <span class="n">stokes_fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                <span class="n">mappable_stokes</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">parameter</span><span class="o">.</span><span class="n">measure_unit</span><span class="p">,</span>
                <span class="n">fraction</span><span class="o">=</span><span class="n">data_ratio</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">image_fig</span><span class="p">,</span> <span class="n">imageax</span><span class="p">,</span> <span class="n">stokes_fig</span><span class="p">,</span> <span class="n">stokesax</span></div>

<div class="viewcode-block" id="MicropolImage.show_single_pol_images"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.show_single_pol_images">[docs]</a>    <span class="k">def</span> <span class="nf">show_single_pol_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the four polarizations images.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmap (str, optional): colormap for the plot. Defaults to &quot;Greys_r&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: a (figure, axis) couple same as matplotlib.pyplot.subplots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">polslist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pol0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol45</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_45</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pol</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">polslist</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
            <span class="n">mappable</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pol</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">pol</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [px]&quot;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [px]&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                <span class="n">mappable</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">pol</span><span class="o">.</span><span class="n">measure_unit</span><span class="p">,</span>
                <span class="n">fraction</span><span class="o">=</span><span class="n">data_ratio</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="MicropolImage.show_demo_images"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.show_demo_images">[docs]</a>    <span class="k">def</span> <span class="nf">show_demo_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the four demosaiced images.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmap (str, optional): colormap for the plot. Defaults to &quot;Greys_r&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: a (figure, axis) couple same as matplotlib.pyplot.subplots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_demosaiced</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s2">&quot;Image is not yet demosaiced.&quot;</span><span class="p">)</span>
        <span class="n">data_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">demo_images_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">single_demo_ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
            <span class="n">mappable</span> <span class="o">=</span> <span class="n">single_demo_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">demo_images_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">mean_minus_std</span><span class="p">(</span><span class="n">demo_images_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">mean_plus_std</span><span class="p">(</span><span class="n">demo_images_list</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">single_demo_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Demosaiced image </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">single_demo_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [px]&quot;</span><span class="p">)</span>
            <span class="n">single_demo_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [px]&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                <span class="n">mappable</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">single_demo_ax</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DN&quot;</span><span class="p">,</span>
                <span class="n">fraction</span><span class="o">=</span><span class="n">data_ratio</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="MicropolImage.show_pol_param"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.show_pol_param">[docs]</a>    <span class="k">def</span> <span class="nf">show_pol_param</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">polparam</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots a single polarization parameter given as input</span>

<span class="sd">        Args:</span>
<span class="sd">            polparam (str): image PolParam containing the parameter to plot. Can be one among [I, Q, U, pB, AoLP, DoLP]</span>
<span class="sd">            cmap (str, optional): colormap for the plot. Defaults to &quot;Greys_r&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: a (figure, axis) couple same as matplotlib.pyplot.subplots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">polparam</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polparam</span><span class="p">)</span>
        <span class="n">data_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">mean_minus_std</span><span class="p">(</span><span class="n">polparam</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">mean_plus_std</span><span class="p">(</span><span class="n">polparam</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mappable</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">polparam</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">polparam</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [px]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [px]&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
            <span class="n">mappable</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">polparam</span><span class="o">.</span><span class="n">measure_unit</span><span class="p">,</span>
            <span class="n">fraction</span><span class="o">=</span><span class="n">data_ratio</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

    <span class="c1"># ----------------------------------------------------------------</span>
    <span class="c1"># -------------------------- SAVING ------------------------------</span>
    <span class="c1"># ----------------------------------------------------------------</span>

<div class="viewcode-block" id="MicropolImage.save_single_pol_images"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.save_single_pol_images">[docs]</a>    <span class="k">def</span> <span class="nf">save_single_pol_images</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fixto</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the four polarized images as fits files</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): filename of the output image. The four images will be saved as filename_POLXX.fits</span>
<span class="sd">            fixto (list[float, float], optional): set the minimum and maximum value for the output images. Defaults to None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: an invalid file name is provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">polslist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pol0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol45</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_45</span><span class="p">]</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_make_abs_and_create_dir</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.fits&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filename must be a valid file name, not folder.&quot;</span><span class="p">)</span>
        <span class="n">group_filepath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">filepath</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">single_pol</span> <span class="ow">in</span> <span class="n">polslist</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;POL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">single_pol</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;Micropolarizer orientation&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fixto</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">single_pol</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">fixto</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">single_pol</span><span class="o">.</span><span class="n">data</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">,</span>
                <span class="n">do_not_scale_image_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">uint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">filename_with_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">group_filepath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">group_filepath</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;POL&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">single_pol</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename_with_ID</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All params successfully saved to &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MicropolImage.save_param_as_fits"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.save_param_as_fits">[docs]</a>    <span class="k">def</span> <span class="nf">save_param_as_fits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">polparam</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fixto</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves chosen polarization parameter as a fits file</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): filename of the output image.</span>
<span class="sd">            polparam (str): polarization parameter to save. Can be one among [I, Q, U, pB, AoLP, DoLP]</span>
<span class="sd">            fixto (list[float, float], optional): set the minimum and maximum value for the output images. Defaults to None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: filename is not a valid .fits file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">polparam</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polparam</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_make_abs_and_create_dir</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.fits&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filename must be a valid file name, not folder.&quot;</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;PARAM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">polparam</span><span class="o">.</span><span class="n">title</span><span class="p">),</span> <span class="s2">&quot;Polarization parameter&quot;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;UNITS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">polparam</span><span class="o">.</span><span class="n">measure_unit</span><span class="p">),</span> <span class="s2">&quot;Measure units&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fixto</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">polparam</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">fixto</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">polparam</span><span class="o">.</span><span class="n">data</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">,</span>
            <span class="n">do_not_scale_image_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">uint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">filename_with_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">filepath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">filepath</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">polparam</span><span class="o">.</span><span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># filename = _make_abs_and_create_dir(filename)</span>
        <span class="c1"># filename_with_ID = (</span>
        <span class="c1">#    filename.split(&quot;.&quot;)[-2] + &quot;_&quot; + polparam.ID + &quot;.fits&quot;</span>
        <span class="c1"># )</span>

        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename_with_ID</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">filename_with_ID</span><span class="si">}</span><span class="s1">&quot; </span><span class="si">{</span><span class="n">polparam</span><span class="o">.</span><span class="n">ID</span><span class="si">}</span><span class="s1"> successfully saved&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MicropolImage.save_all_pol_params_as_fits"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.save_all_pol_params_as_fits">[docs]</a>    <span class="k">def</span> <span class="nf">save_all_pol_params_as_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the image and all polarization parameters as fits file with the same name</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): filename of the output image. Will be saved as filename_[I, Q, U, pB, AoLP, DoLP].fits</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: filename is not a valid .fits file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.fits&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filename must be a valid file name, not folder.&quot;</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_make_abs_and_create_dir</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">group_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">filepath</span><span class="o">.</span><span class="n">stem</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">polparam_list</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;PARAM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">title</span><span class="p">),</span> <span class="s2">&quot;Polarization parameter&quot;</span><span class="p">)</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;UNITS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">measure_unit</span><span class="p">),</span> <span class="s2">&quot;Measure units&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">fix_data</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">data</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">,</span>
                <span class="n">do_not_scale_image_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">uint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">filename_with_ID</span> <span class="o">=</span> <span class="n">group_filename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">ID</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename_with_ID</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All params successfully saved to &quot;</span><span class="si">{</span><span class="n">group_filename</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MicropolImage.save_demosaiced_images_as_fits"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.save_demosaiced_images_as_fits">[docs]</a>    <span class="k">def</span> <span class="nf">save_demosaiced_images_as_fits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fixto</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the four demosaiced images as fits files</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): filename of the output image. The four images will be saved as filename_POLXX.fits</span>
<span class="sd">            fixto (list[float, float], optional): set the minimum and maximum value for the output images. Defaults to None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: an invalid file name is provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_demosaiced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Demosaiced images not yet calculated.&quot;</span><span class="p">)</span>
        <span class="n">imageHdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filename must be a valid file name, not folder.&quot;</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_make_abs_and_create_dir</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">group_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">filepath</span><span class="o">.</span><span class="n">stem</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">demo_image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span><span class="p">):</span>
            <span class="n">POL_ID</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">imageHdr</span><span class="p">[</span><span class="s2">&quot;POL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">POL_ID</span><span class="p">),</span> <span class="s2">&quot;Micropolarizer orientation&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fixto</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">demo_image</span><span class="p">,</span> <span class="o">*</span><span class="n">fixto</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">demo_image</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">imageHdr</span><span class="p">,</span>
                <span class="n">do_not_scale_image_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">uint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">new_filename</span> <span class="o">=</span> <span class="n">group_filename</span> <span class="o">+</span> <span class="s2">&quot;_POL&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">POL_ID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Demosaiced images successfully saved to &quot;</span><span class="si">{</span><span class="n">group_filename</span><span class="si">}</span><span class="s1">_POLX.fits&quot;&#39;</span>
        <span class="p">)</span></div>

    <span class="c1"># ----------------------------------------------------------------</span>
    <span class="c1"># -------------------- DATA MANIPULATION -------------------------</span>
    <span class="c1"># ----------------------------------------------------------------</span>
<div class="viewcode-block" id="MicropolImage.demosaic"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.demosaic">[docs]</a>    <span class="k">def</span> <span class="nf">demosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">demosaic_mode</span><span class="o">=</span><span class="s2">&quot;adjacent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a demosaiced copy of the image with updated polarization parameters. Demoisacing is done IN PLACE.</span>

<span class="sd">        Args:</span>
<span class="sd">            demosaic_mode (str, optional): demosaicing mode (see processing.demosaic). Defaults to &quot;adjacent&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MicropolImage: demosaiced image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span> <span class="o">=</span> <span class="n">demosaic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">demosaic_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_demosaiced</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_theo_Stokes_vec_components</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MicropolImage.rebin"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.rebin">[docs]</a>    <span class="k">def</span> <span class="nf">rebin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binning</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rebins the micropolarizer array image, binned each</span>
<span class="sd">        binningxbinning. Sum bins by default.</span>

<span class="sd">        Args:</span>
<span class="sd">            binning (int): binning to perform. A value of n will be translated in a nxn binning.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: negative binning provided</span>

<span class="sd">        Returns:</span>
<span class="sd">            MicropolImage: copy of the input image, rebinned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">binning</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Negative binning </span><span class="si">{</span><span class="n">binning</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">binning</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rebinned_image</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">rebinned_data</span> <span class="o">=</span> <span class="n">micropolarray_rebin</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rebinned_image</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="o">*</span><span class="n">rebinned_image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">binning</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">rebinned_image</span><span class="o">.</span><span class="n">_update_data_and_Stokes</span><span class="p">(</span><span class="n">rebinned_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rebinned_image</span></div>

<div class="viewcode-block" id="MicropolImage.congrid"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.congrid">[docs]</a>    <span class="k">def</span> <span class="nf">congrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newdim_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">newdim_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
        <span class="c1"># Trim to nearest superpixel</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newdim_y</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newdim_x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">newdim_y</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">newdim_y</span> <span class="o">=</span> <span class="n">newdim_y</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">newdim_x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">newdim_x</span> <span class="o">=</span> <span class="n">newdim_x</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;New dimension was incompatible with superpixels. Trimmed to (</span><span class="si">{</span><span class="n">newdim_y</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">newdim_x</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="n">new_subdims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">newdim_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">newdim_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">congridded_pol_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="n">new_subdims</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subimage_i</span><span class="p">,</span> <span class="n">pol_subimage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">single_pol_subimages</span><span class="p">):</span>
            <span class="n">congridded_pol_images</span><span class="p">[</span><span class="n">subimage_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">congrid</span><span class="p">(</span>
                <span class="n">pol_subimage</span><span class="p">,</span> <span class="n">new_subdims</span>
            <span class="p">)</span>
        <span class="n">newdata</span> <span class="o">=</span> <span class="n">merge_polarizations</span><span class="p">(</span><span class="n">congridded_pol_images</span><span class="p">)</span>
        <span class="n">newimage</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">newdata</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">congrid</span><span class="p">(</span><span class="n">stokes_component</span><span class="p">,</span> <span class="p">[</span><span class="n">newdim_y</span><span class="p">,</span> <span class="n">newdim_x</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">stokes_component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">newimage</span></div>

<div class="viewcode-block" id="MicropolImage.rotate"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rotates an image of angle degrees, counter-clockwise.&quot;&quot;&quot;</span>

        <span class="n">single_pols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_pol_subimages</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">PILImage</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">single_pols</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">single_pols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">merge_polarizations</span><span class="p">(</span><span class="n">single_pols</span><span class="p">)</span>

        <span class="n">Stokes_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">PILImage</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">Stokes_vec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">Stokes_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">newimage</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">Stokes_vec</span> <span class="o">=</span> <span class="n">Stokes_vec</span>

        <span class="k">return</span> <span class="n">newimage</span></div>

<div class="viewcode-block" id="MicropolImage.mask_occulter"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.mask_occulter">[docs]</a>    <span class="k">def</span> <span class="nf">mask_occulter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">PolarCam</span><span class="p">()</span><span class="o">.</span><span class="n">occulter_pos_last</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">PolarCam</span><span class="p">()</span><span class="o">.</span><span class="n">occulter_pos_last</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">r</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">PolarCam</span><span class="p">()</span><span class="o">.</span><span class="n">occulter_pos_last</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">overoccult</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Masks occulter for all image parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            y (int, optional): Occulter y position. Defaults to PolarCam().occulter_pos_last[0].</span>
<span class="sd">            x (int, optional): Occulter x position. Defaults to PolarCam().occulter_pos_last[1].</span>
<span class="sd">            r (int, optional): Occulter radius. Defaults to PolarCam().occulter_pos_last[2].</span>
<span class="sd">            overoccult (int, optional): Pixels to overoccult. Defaults to 0.</span>
<span class="sd">            camera (_type_, optional): Camera image type. Defaults to PolarCam().</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># y, x, r = camera.occulter_pos_last</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">overoccult</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">roi_from_polar</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
            <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">))],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_demosaiced</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">roi_from_polar</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">])),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">demosaiced_images</span>
            <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">roi_from_polar</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Stokes_vec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
                <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">))],</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="MicropolImage.shift"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shifts image by y, x pixels and fills with 0 the remaining space. Positive numbers for up/right shift and negative for down/left shift. Image is split into polarizations, each one is shifted, then they are merged again.</span>

<span class="sd">        Args:</span>
<span class="sd">            y (int): vertical shift in pix</span>
<span class="sd">            x (int): horizontal shift in pix</span>

<span class="sd">        Returns:</span>
<span class="sd">            MicropolImage: shifted image copied from the original</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># newdata = shift(self.data, y, x)</span>
        <span class="n">newdata</span> <span class="o">=</span> <span class="n">shift_micropol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">newimage</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">_update_data_and_Stokes</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newimage</span></div>

<div class="viewcode-block" id="MicropolImage.clean_hot_pixels"><a class="viewcode-back" href="../../micropolarray.html#micropolarray.micropol_image.MicropolImage.clean_hot_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">clean_hot_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flagged_hot_pix_map</span><span class="p">:</span> <span class="n">MicropolImage</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a copy of the image with gaussian smeared pixels where flagged_hot_pix_map == 1.</span>

<span class="sd">        Args:</span>
<span class="sd">            flagged_hot_pix_map (MicropolImage): hot pixels map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MicropolImage: copy of the original image, gaussian smeared where flagged_hot_pix_map == 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subimages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_pol_subimages</span>
        <span class="n">blurred_subimages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">subimage</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">subimage</span> <span class="ow">in</span> <span class="n">subimages</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">flagged_subimages</span> <span class="o">=</span> <span class="n">flagged_hot_pix_map</span><span class="o">.</span><span class="n">single_pol_subimages</span>
        <span class="n">subimages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">flagged_subimages</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">blurred_subimages</span><span class="p">,</span> <span class="n">subimages</span>
        <span class="p">)</span>

        <span class="n">newimage</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">newimage</span><span class="o">.</span><span class="n">_update_data_and_Stokes</span><span class="p">(</span><span class="n">merge_polarizations</span><span class="p">(</span><span class="n">subimages</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">newimage</span></div>

    <span class="c1"># ----------------------------------------------------------------</span>
    <span class="c1"># ------------------------ OVERLOADING ---------------------------</span>
    <span class="c1"># ----------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">second</span><span class="p">):</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">second</span><span class="o">.</span><span class="n">data</span>
            <span class="n">newimage</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">newimage</span><span class="o">.</span><span class="n">_update_data_and_Stokes</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newimage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">second</span>
            <span class="k">return</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="n">newdata</span><span class="p">,</span> <span class="n">angle_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">second</span><span class="p">):</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">second</span><span class="o">.</span><span class="n">data</span>
            <span class="n">newimage</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">newimage</span><span class="o">.</span><span class="n">_update_data_and_Stokes</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newimage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">second</span>
            <span class="k">return</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="n">newdata</span><span class="p">,</span> <span class="n">angle_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">second</span><span class="p">):</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">second</span><span class="o">.</span><span class="n">data</span>
            <span class="n">newimage</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">newimage</span><span class="o">.</span><span class="n">_update_data_and_Stokes</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newimage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">second</span>
            <span class="k">return</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="n">newdata</span><span class="p">,</span> <span class="n">angle_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MicropolImage</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">second</span><span class="p">):</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">second</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">second</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="mf">0.0</span>
            <span class="p">)</span>
            <span class="n">newimage</span> <span class="o">=</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">newimage</span><span class="o">.</span><span class="n">_update_data_and_Stokes</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newimage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># newdata = np.where(second != 0, self.data / second, 4096)</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">second</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">MicropolImage</span><span class="p">(</span><span class="n">newdata</span><span class="p">,</span> <span class="n">angle_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_dic</span><span class="p">)</span></div>


<span class="c1"># provide shorter aliases</span>
<span class="c1"># PolarcamImage = MicropolImage</span>
<span class="c1"># MicropolImage = MicropolImage</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Herve Haudemand.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>